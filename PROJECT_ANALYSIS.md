# Детальний аналіз EduVision CRM

## Огляд
- **Призначення**: веб-CRM для освітнього центру з багаторольовою підтримкою (адміністратор, вчитель, батько, учень) та мінімалістичним адаптивним UI. 【F:CRM_IMPLEMENTATION.md†L3-L103】
- **Технологічний стек**: Flask + Supabase на бекенді, статичний фронтенд (HTML/CSS/JS) з власними утилітами, Playwright для генерації PDF/браузерних задач, інтеграція з Telegram-ботом. 【F:main.py†L1-L199】【F:web/js/app.js†L1-L363】

## Архітектура бекенду
- **Вхідна точка**: `main.py` ініціалізує Flask, CORS, динамічно завантажує всі API-модулі, підключає глобальний lock та Telegram-бот, а також керує життєвим циклом Chromium через Playwright (warm-up + idle monitor). 【F:main.py†L19-L199】
- **Динамічні API**: модулі з каталогу `api/` автозавантажуються та реєструють blueprints, що спрощує розширення функціонала без ручного імпорту. 【F:main.py†L91-L119】
- **Розмежування баз**: `api/coreapiserver.py` тримає два клієнти Supabase (main/stock) та мапу таблиць, що визначає цільову БД; додано in-memory кеш TTL і middleware для вибіркового глобального lock на критичних роутингах. 【F:api/coreapiserver.py†L14-L139】
- **Функціональні модулі**: окремі файли реалізують доменні зони (курси, групи, студенти, відвідуваність, платежі). Наприклад, `api/courses.py` надає CRUD із валідацією, фільтром `is_active` та очищенням кешу після запису. 【F:api/courses.py†L1-L127】
- **Аутентифікація та відновлення**: `api/login/join.py` обслуговує сесійні cookie (`edu_session`), підтримує кілька ролей для одного email, перевіряє bcrypt/PBKDF2/PLAINTEXT хеші та містить сценарії відновлення через email/Telegram із контрольними TTL та фолбеками. 【F:api/login/join.py†L23-L195】

## Дані та міграції
- **Схема Supabase**: `db_migrations/01_create_crm_tables.sql` створює ядро CRM (courses, groups, group_students, lessons, attendance, payments) з базовими індексами та слабкими зв’язками (ON DELETE SET NULL/CASCADE). 【F:db_migrations/01_create_crm_tables.sql†L1-L86】
- **Кешування**: читання/запис використовують in-memory кеш з TTL 30 хвилин; після записів виклики `clear_cache` гарантують актуальні дані. 【F:api/coreapiserver.py†L84-L109】【F:api/courses.py†L70-L120】

## Фронтенд
- **Структура**: статичні HTML для кожної ролі (admin/teacher/parent/student) та спільні ресурси `css/styles.css`, `js/app.js`. Опис структури наведений у документації реалізації. 【F:CRM_IMPLEMENTATION.md†L31-L53】
- **Утиліти JS**: `web/js/app.js` надає API helper (fetch з cookie), керування сесією користувача, UI-хелпери (модальні вікна, алерти, лоадер), генератор таблиць і форм, а також навігаційний highlighter. 【F:web/js/app.js†L5-L363】
- **Ролі та навігація**: методи `isAdmin/isTeacher/isParent/isStudent` визначають доступ на основі `user_access/extra_access`, а DOMContentLoaded обробляє ініціалізацію та logout. 【F:web/js/app.js†L67-L355】

## Інтеграції та служби
- **Playwright**: запускається headless Chromium для PDF/рендер-завдань; фоновий монітор закриває простоюючі екземпляри, що обмежує споживання ресурсів. 【F:main.py†L24-L85】
- **Telegram-бот**: фонова нитка активується за наявності `TELEGRAM_BOT_TOKEN`, логування відмов без падіння сервера. 【F:main.py†L133-L164】
- **Email/TG recovery**: аутентифікаційний модуль використовує Gmail-сервіс та Telegram для відновлення доступу, з можливістю увімкнення/вимкнення через env або таблицю `uni_base`. 【F:api/login/join.py†L23-L166】

## Сильні сторони
- Чітке розділення доменів через Blueprints та автозавантаження API модулів.
- Гнучке підключення до двох Supabase БД з картографуванням таблиць, що дозволяє масштабувати та розділяти навантаження.
- Адаптивний фронтенд із спільним набором JS-хелперів, що забезпечує єдині UX-патерни для всіх ролей.
- Наявність міграції з індексами забезпечує стартову продуктивність аналітичних/CRUD запитів.

## Ризики та зони уваги
- Відсутність scheduler'а (відключений через помилки таблиці) — фонові задачі не виконуються. 【F:main.py†L121-L125】
- Без стороннього кеша всі вузькі місця кешуються лише в пам’яті одного процеса; масштабування кількох інстансів потребуватиме зовнішнього кеша.
- Обробка помилок у Playwright/боті переважно логічна; варто додати сповіщення/health-check при збоях.
- Немає автоматичних тестів у репозиторії; якість залежить від ручного тестування.

## Рекомендації
1. **Увімкнути/виправити scheduler** після створення таблиці `scheduled_tasks` у потрібній БД або додати перевірку існування таблиці перед запуском. 【F:main.py†L121-L125】
2. **Додати інтеграційні тести** для ключових API (курси, групи, логін) з використанням тестового Supabase або моків.
3. **Винести кеш у Redis/Memcached** для роботи в багатопроцесному середовищі та додати інвалідатори для інших модулів, не лише курсів.
4. **Розширити фронтенд ролей**: додати видимість доступних дій згідно з `User` ролями та покрити кейси невдалого завантаження сесії.
5. **Безпека**: перевірити `COOKIE_SECURE`/`CORS` конфіг у продакшні та додати rate-limiting на auth endpoints.
