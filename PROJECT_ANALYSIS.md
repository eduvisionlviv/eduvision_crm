# Детальний аналіз EduVision CRM

## Огляд системи
- **Призначення**: веб-CRM для освітнього центру з багаторольовою підтримкою (адміністратор, вчитель, батько, учень) та мінімалістичним адаптивним UI.【F:CRM_IMPLEMENTATION.md†L3-L103】
- **Технологічний стек**: Flask + Supabase на бекенді, статичний фронтенд (HTML/CSS/JS) з власними утилітами, Playwright для PDF/браузерних задач та інтеграція з Telegram-ботом.【F:main.py†L1-L199】【F:web/js/app.js†L1-L363】

## Архітектура бекенду
- **Вхідна точка**: `main.py` ініціалізує Flask, CORS, динамічно підвантажує API-модулі, підключає глобальний lock і Telegram-бот, а також керує життєвим циклом Chromium через Playwright (warm-up + idle monitor).【F:main.py†L19-L199】
- **Динамічні API**: усі модулі з каталогу `api/` автозавантажуються та реєструють blueprints, що спрощує розширення без ручних імпортів.【F:main.py†L91-L119】
- **Розмежування баз**: `api/coreapiserver.py` підтримує два клієнти Supabase (main/stock) та карту таблиць для вибору цільової БД; додає in-memory кеш TTL і middleware для вибіркового глобального lock на критичних роутингах.【F:api/coreapiserver.py†L14-L139】
- **Функціональні модулі**: окремі файли реалізують доменні зони (курси, групи, студенти, відвідуваність, платежі). Наприклад, `api/courses.py` надає CRUD із валідацією, фільтром `is_active` та очищенням кешу після запису.【F:api/courses.py†L1-L127】
- **Аутентифікація та відновлення**: `api/login/join.py` обслуговує сесійні cookie (`edu_session`), підтримує кілька ролей для одного email, перевіряє bcrypt/PBKDF2/PLAINTEXT хеші та містить сценарії відновлення через email/Telegram із контрольними TTL і фолбеками.【F:api/login/join.py†L23-L195】

## Дані та міграції
- **Схема Supabase**: `db_migrations/01_create_crm_tables.sql` створює ядро CRM (courses, groups, group_students, lessons, attendance, payments) з базовими індексами та зв’язками `ON DELETE SET NULL/CASCADE`.【F:db_migrations/01_create_crm_tables.sql†L1-L86】
- **Кешування**: читання/запис використовують in-memory кеш із TTL 30 хвилин; після записів виклики `clear_cache` забезпечують актуальність даних.【F:api/coreapiserver.py†L84-L109】【F:api/courses.py†L70-L120】

## Фронтенд
- **Структура**: статичні HTML для ролей (admin/teacher/parent/student) та спільні ресурси `css/styles.css`, `js/app.js`, описані в документації реалізації.【F:CRM_IMPLEMENTATION.md†L31-L53】
- **Утиліти JS**: `web/js/app.js` забезпечує API helper (fetch із cookie), керування сесією, UI-хелпери (модальні вікна, алерти, лоадер), генератор таблиць/форм і навігаційний highlighter.【F:web/js/app.js†L5-L363】
- **Ролі та навігація**: методи `isAdmin/isTeacher/isParent/isStudent` визначають доступ на основі `user_access/extra_access`, а DOMContentLoaded обробляє ініціалізацію та logout.【F:web/js/app.js†L67-L355】

## Інтеграції та служби
- **Playwright**: запускає headless Chromium для PDF/рендер-завдань; фоновий монітор закриває простоюючі екземпляри, зменшуючи споживання ресурсів.【F:main.py†L24-L85】
- **Telegram-бот**: фонова нитка активується за наявності `TELEGRAM_BOT_TOKEN`, з логуванням відмов без падіння сервера.【F:main.py†L133-L164】
- **Email/TG recovery**: аутентифікаційний модуль використовує Gmail-сервіс та Telegram для відновлення доступу, з можливістю увімкнення/вимкнення через env або таблицю `uni_base`.【F:api/login/join.py†L23-L166】

## Сильні сторони
- Чітке розділення доменів через Blueprints та автозавантаження модулів.
- Два Supabase-клієнти з картографуванням таблиць дозволяють розділяти навантаження.
- Адаптивний фронтенд із спільними JS-хелперами формує єдині UX-патерни для всіх ролей.
- Наявність базової міграції з індексами покриває стартові CRUD/аналітичні запити.

## Ризики та зони уваги
- Відсутність scheduler'а (відключений через помилки таблиці) — фонові задачі не виконуються.【F:main.py†L121-L125】
- Кеш лише в пам’яті одного процеса; для масштабування знадобиться зовнішній кеш.
- Обробка помилок у Playwright/боті переважно логічна; немає сповіщень/health-check.
- Автоматичні тести відсутні; покриття залежить від ручного тестування.
- UX аутентифікації наразі обмежується повідомленням «невірний email або пароль» без підказок щодо відновлення доступу.

## Рекомендації (пріоритезація)
1. **Виправити запуск scheduler'а**: створити таблицю `scheduled_tasks` у потрібній БД або додати перевірку існування таблиці перед стартом, щоб фонові задачі працювали стабільно.【F:main.py†L121-L125】
2. **Додати інтеграційні тести** для ключових API (курси, групи, логін) із тестовим Supabase або моками, щоб мати мінімальне регресійне покриття.
3. **Винести кеш у Redis/Memcached** та додати інвалідатори для всіх модулів (не лише курсів), щоб підготуватися до горизонтального масштабування.
4. **Поліпшити UX аутентифікації**: додати чіткі повідомлення та прямі посилання на відновлення доступу (email/TG), а також обмеження кількості спроб логіну для захисту від brute-force.
5. **Додати сповіщення/health-check** для Playwright і Telegram-бота (наприклад, через webhook або internal status page), щоб швидше виявляти збої.
6. **Переглянути налаштування безпеки**: увімкнути `COOKIE_SECURE` у продакшні, звузити CORS і додати rate-limiting на auth endpoints.
