# Вхід з вибором ролі та навчального центру

Цей документ описує, як працює оновлений механізм логіну, вибору ролі та навчального центру. Він пояснює, що відбувається на бекенді і які кроки бачить користувач на фронтенді.

## Які ролі й таблиці підтримуються
- **contacts** → роль `def` (співробітники, менеджери, адміністратори центрів).
- **parents** → роль `parent`.
- **student** → роль `student`.
- Додаткові ролі з поля `extra_access`: `teacher`, `lc_manager`, `super_admin` тощо. Всі вони нормалізуються у бекенді до єдиного списку.

## Як бекенд збирає профілі користувача
1. `/api/login/join` шукає акаунти з однаковим email у таблицях **contacts**, **parents**, **student**.
2. Для кожного акаунта бекенд:
   - Нормалізує список ролей (`available_roles`).
   - Визначає центр за полями `center_id`, `lc_id`, `branch_id`, `tenant_id`, `base_id` тощо.
   - Формує профіль `{table, user_id, user_name, role, roles, center_id, center_label}`.
3. Якщо в акаунті є кілька ролей (наприклад, `super_admin` + `teacher`), профілі дублюються так, щоб користувач зміг обрати конкретну роль/центр.

## Сценарії з однаковим логіном/паролем
- **Один логін та пароль, але кілька ролей**: після введення даних фронтенд показує список профілів. Користувач обирає конкретну роль/центр і надсилає вибір на бекенд.
- **Батько та учень з однаковим логіном/паролем**: кожен запис у таблицях дає окремий профіль. Фронтенд просить обрати, хто саме заходить.
- **Співробітник із різними паролями для ролей**: перевірка пароля йде проти кожного акаунта; у профілі потрапляють лише ті записи, де пароль співпав.

## Як працює вибір профілю
1. Після введення логіна/пароля бекенд повертає `profiles` із можливими варіантами входу.
2. Фронтенд викликає `/api/login/switch_profile` з полями `table`, `user_id`, `role`, `center_id` згідно з обраним профілем.
3. Бекенд:
   - Видає новий токен сесії для конкретного акаунта.
   - Ставить кукі: `edu_session`, `edu_role`, `edu_center` (7 днів за замовчуванням).
4. Після відповіді сторінка перезавантажується і показує дашборд відповідної ролі.

## Супер-адміністратор і кілька центрів
- Якщо в списку ролей є `super_admin`, у профілях відображається роль `super_admin` без прив’язки до центру — вона дає доступ до всіх центрів.
- Звичайні ролі (`teacher`, `def`, `parent`, `student`) прив’язані до конкретного `center_id`. Ті ж самі логін/пароль можуть дати кілька профілів, якщо користувач належить до різних центрів.

## Кукі та стійкість сесії
- `edu_session` — токен авторизації.
- `edu_role` — активна роль, яку обрав користувач. Фронтенд читає її, щоб показувати правильне меню/сторінку після перезавантаження.
- `edu_center` — активний навчальний центр для даної ролі.
- Термін дії — `AUTH_TTL_HOURS` (за замовчуванням 7 діб). Кукі мають флаг `SameSite=Lax`, `HttpOnly`, `Secure`.

## Помилки та підказки для користувача
- Якщо жоден профіль не підтверджує пароль — повертається помилка «Невірний email або пароль».
- Якщо акаунт знайдено, але Telegram-підключення обов’язкове — у відповіді буде `need_tg_setup=true`, і фронтенд пропонує лінк на бота.
- Для відновлення доступу працюють сценарії через Telegram або email залежно від налаштувань середовища.

## Коротка послідовність дій при логіні
1. Користувач вводить email і пароль, надсилає запит на `/api/login/join`.
2. Отримує список профілів. Якщо профіль один — бекенд одразу видає сесію і ставить кукі. Якщо профілів кілька — фронтенд показує вибір.
3. Користувач натискає потрібну роль/центр, фронтенд викликає `/api/login/switch_profile`.
4. Отримує кукі `edu_session` + `edu_role` + `edu_center`, сторінка перезавантажується, відкривається потрібний дашборд.

