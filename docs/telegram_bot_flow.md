# Telegram-бот: покрокова логіка підключення

Цей документ пояснює, що відбувається у бекенді, коли користувач підключає Telegram-бота Helen Doron English до свого акаунта EduVision. Усі URL наведені відносно бекенду (`URL`/`APP_BASE_URL`); змінна `crm_url`/`CRM_URL` використовується для побудови посилань на веб-кабінет.

## Передумови
- Бот має токен `TELEGRAM_BOT_TOKEN` (або шлях у `TELEGRAM_BOT_TOKEN_FILE`/`BOT_TOKEN_FILE`).
- На бекенді виставлено `crm_url` або `CRM_URL` (як запас використовується `PUBLIC_APP_URL`).
- Поле у таблиці `contacts`, куди пишеться Telegram, — `recovery_tg_id` (також дублюється у `user_tg_id`).

## Потік 1: користувач натискає «Підключити Telegram» на сайті
1. **Авторизація у браузері.** Користувач входить у власний акаунт на сайті.
2. **Запит на лист з посиланням.** Фронтенд викликає `POST /api/auth/send_tg_link` з cookie `edu_session`.
   - Бекенд підписує ID користувача та формує посилання `https://t.me/<bot>?start=<token>` (де `.` замінені на `-`).
   - Якщо налаштована пошта, бекенд надсилає лист із цим посиланням; інакше повертає `bot_link` у відповіді.
3. **Перехід у бот.** Користувач відкриває посилання і тисне **Start**. Бот отримує токен у `link_token` та показує кнопку «Поділитися телефоном ☎️».
4. **Надсилання контакту.** Користувач ділиться власним номером. Бот викликає `POST /api/tg/link_recovery` з полями `chat_id`, `phone`, `user_token` (токен зі start).
5. **Перевірка на бекенді.**
   - Токен розшифровується у `user_id` (TTL за замовчуванням 10 годин).
   - Витягується телефон із `contacts.user_phone` для цього користувача.
   - Якщо у картці немає телефону — відповідь `status="missing_phone"` + інструкція звернутися до адміністратора.
   - Якщо телефон із Telegram ≠ телефону в базі — `status="phone_mismatch"` + інструкція оновити номер.
   - Якщо телефони збігаються — у `contacts` оновлюються `recovery_tg_id` та `user_tg_id` на `chat_id`, кеш таблиці чиститься.
6. **Відповідь у бот.** При успіху користувач бачить `TG_SUCCESS_TEXT` з проханням повернутися на сайт та зайти в акаунт знову.

## Потік 2: користувач знаходить бота пошуком у Telegram
1. **Старт без токена.** Користувач тисне Start, але у `start`-параметрі немає токена.
2. **Надсилання контакту.** Користувач ділиться номером телефону; бот знову викликає `POST /api/tg/link_recovery`, але вже **без** `user_token`.
3. **Пошук телефону в базі.** Бекенд нормалізує номер і шукає відповідність по всіх таблицях входу (`contacts`, `parents`, `student`).
   - **Якщо номер знайдено:** відповідь `status="phone_found"` із текстом, який просить зайти на сайт (`crm_url`) у власний кабінет і натиснути «Підключити Telegram». Це захищає від прив'язки чужих акаунтів.
   - **Якщо номер не знайдено:** відповідь `status="phone_not_found"` із пропозицією зареєструватися на сайті (`crm_url`) і після цього повернутися до бота.
4. **Подальші дії.** Після реєстрації/логіну користувач повторює потік 1 для безпечної прив'язки.

## Що користувач бачить у боті
- Усі тексти, що приходять у відповідь, віддаються з бекенду у полі `bot_text` (наприклад, `TG_SUCCESS_TEXT`, `TG_NO_PHONE_TEXT`, `TG_MISMATCH_TEXT`).
- Бот лише відображає отримане повідомлення та прибирає клавіатуру після відправлення контакту.

## Діагностика
- `GET /api/tg/status` повертає стан бота: наявність токена, `username`, базовий URL API.
- Логи бота (`services/tg_bot.py`) показують payload, який відправляється на бекенд, та відповіді CRM.

## Коротко: навіщо токен у start-посиланні
Токен гарантує, що Telegram-підключення виконує саме той користувач, який залогінився на сайті й натиснув кнопку. Без токена ми лише підказуємо, що робити, але не виконуємо прив'язку, доки користувач не підтвердить свою особу через сайт.
