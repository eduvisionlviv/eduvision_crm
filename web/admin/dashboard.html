<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduVision CRM - –ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar (Desktop) -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <span>üìö</span>
        <span>EduVision CRM</span>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li><a href="/admin/dashboard.html" class="active"><span class="icon">üìä</span> –ì–æ–ª–æ–≤–Ω–∞</a></li>
          <li><a href="/admin/courses.html"><span class="icon">üìñ</span> –ö—É—Ä—Å–∏</a></li>
          <li><a href="/admin/groups.html"><span class="icon">üë•</span> –ì—Ä—É–ø–∏</a></li>
          <li><a href="/admin/students.html"><span class="icon">üéì</span> –£—á–Ω—ñ</a></li>
          <li><a href="/admin/teachers.html"><span class="icon">üë©‚Äçüè´</span> –í—á–∏—Ç–µ–ª—ñ</a></li>
          <li><a href="/admin/payments.html"><span class="icon">üí∞</span> –ü–ª–∞—Ç–µ–∂—ñ</a></li>
          <li><a href="/admin/settings.html"><span class="icon">‚öôÔ∏è</span> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a></li>
          <li><a href="#" id="logout-btn"><span class="icon">üö™</span> –í–∏—Ö—ñ–¥</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1 class="header-title">–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
        <div class="header-actions">
          <span class="text-muted" id="user-name">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-4">
        <div class="stat-card">
          <div class="stat-label">–í—Å—å–æ–≥–æ —É—á–Ω—ñ–≤</div>
          <div class="stat-value" id="total-students">-</div>
          <div class="stat-change positive" id="students-change">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö –≥—Ä—É–ø</div>
          <div class="stat-value" id="active-groups">-</div>
          <div class="stat-change" id="groups-change">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ö—É—Ä—Å—ñ–≤</div>
          <div class="stat-value" id="total-courses">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–î–æ—Ö—ñ–¥ —Ü—å–æ–≥–æ –º—ñ—Å—è—Ü—è</div>
          <div class="stat-value" id="monthly-income">-</div>
          <div class="stat-change positive" id="income-change">-</div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">–û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó</h2>
          <a href="/admin/activity.html" class="btn btn-sm btn-secondary">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—Å–µ</a>
        </div>
        <div class="card-body" id="recent-activity">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">–®–≤–∏–¥–∫—ñ –¥—ñ—ó</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-3">
            <a href="/admin/courses.html?action=create" class="btn btn-primary">
              <span>üìñ</span> –î–æ–¥–∞—Ç–∏ –∫—É—Ä—Å
            </a>
            <a href="/admin/groups.html?action=create" class="btn btn-primary">
              <span>üë•</span> –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É–ø—É
            </a>
            <a href="/admin/students.html?action=create" class="btn btn-success">
              <span>üéì</span> –ó–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ —É—á–Ω—è
            </a>
          </div>
        </div>
      </div>

      <!-- Upcoming Lessons -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">–ù–∞–π–±–ª–∏–∂—á—ñ –∑–∞–Ω—è—Ç—Ç—è</h2>
          <a href="/admin/schedule.html" class="btn btn-sm btn-secondary">–†–æ–∑–∫–ª–∞–¥</a>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table id="upcoming-lessons">
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞/–ß–∞—Å</th>
                  <th>–ì—Ä—É–ø–∞</th>
                  <th>–ö—É—Ä—Å</th>
                  <th>–í—á–∏—Ç–µ–ª—å</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="5" class="text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
      <a href="/admin/dashboard.html" class="bottom-nav-item active">
        <span class="icon">üìä</span>
        <span>–ì–æ–ª–æ–≤–Ω–∞</span>
      </a>
      <a href="/admin/groups.html" class="bottom-nav-item">
        <span class="icon">üë•</span>
        <span>–ì—Ä—É–ø–∏</span>
      </a>
      <a href="/admin/students.html" class="bottom-nav-item">
        <span class="icon">üéì</span>
        <span>–£—á–Ω—ñ</span>
      </a>
      <a href="/admin/settings.html" class="bottom-nav-item">
        <span class="icon">‚öôÔ∏è</span>
        <span>–©–µ</span>
      </a>
    </nav>
  </div>

  <script src="/js/app.js"></script>
  <script>
    async function loadDashboardData() {
      try {
        // Load user info
        if (User.data) {
          document.getElementById('user-name').textContent = User.data.user_name || '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä';
        }

        // Load statistics
        const [students, groups, courses] = await Promise.all([
          API.get('/students'),
          API.get('/groups'),
          API.get('/courses')
        ]);

        document.getElementById('total-students').textContent = students.students?.length || 0;
        document.getElementById('active-groups').textContent = groups.groups?.filter(g => g.is_active).length || 0;
        document.getElementById('total-courses').textContent = courses.courses?.filter(c => c.is_active).length || 0;

        // Load payment stats (this month)
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString();
        const payments = await API.get(`/payments?date_from=${firstDay}`);
        
        const totalIncome = payments.payments?.reduce((sum, p) => {
          return p.status === 'paid' ? sum + parseFloat(p.amount || 0) : sum;
        }, 0) || 0;
        
        document.getElementById('monthly-income').textContent = UI.formatCurrency(totalIncome);

        // Load upcoming lessons
        await loadUpcomingLessons();

        // Load recent activity
        loadRecentActivity();

      } catch (error) {
        console.error('Error loading dashboard:', error);
        UI.showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö', 'danger');
      }
    }

    async function loadUpcomingLessons() {
      try {
        const today = new Date().toISOString();
        const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
        
        const response = await API.get(`/attendance/lessons?date_from=${today}&date_to=${nextWeek}`);
        const lessons = response.lessons || [];

        const tbody = document.querySelector('#upcoming-lessons tbody');
        tbody.innerHTML = '';

        if (lessons.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">–ù–µ–º–∞—î –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –∑–∞–Ω—è—Ç—å</td></tr>';
          return;
        }

        lessons.slice(0, 10).forEach(lesson => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${UI.formatDateTime(lesson.scheduled_at)}</td>
            <td>${lesson.groups?.name || '-'}</td>
            <td>${lesson.groups?.courses?.name || '-'}</td>
            <td>-</td>
            <td><span class="badge badge-primary">${lesson.status}</span></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('Error loading lessons:', error);
      }
    }

    function loadRecentActivity() {
      const activityDiv = document.getElementById('recent-activity');
      activityDiv.innerHTML = `
        <div class="text-muted text-center">
          <p>–ú–æ–¥—É–ª—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ</p>
        </div>
      `;
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadDashboardData);
  </script>
</body>
</html>
