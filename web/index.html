<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Helen Doron English ‚Äì –í—Ö—ñ–¥ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff" />

  <!-- –Ñ–¥–∏–Ω—ñ —Å—Ç–∏–ª—ñ -->
  <link rel="stylesheet" href="/main/css/theme.css">
  <link rel="stylesheet" href="/main/css/buttons.css">
  <link rel="stylesheet" href="/main/css/inputs.css">
  <link rel="stylesheet" href="/main/css/modal.css">

  <style>
    body{display:flex;flex-direction:column;align-items:center;min-height:100vh;background:var(--color-bg);}
    header{width:100%;background:#fff;padding:12px 0;box-shadow:0 1px 4px rgba(0,0,0,.08);display:flex;justify-content:center;}
    header img{max-width:90%;max-height:70px;height:auto;}
    main{width:100%;max-width:600px;padding:40px 10%;box-sizing:border-box;display:flex;flex-direction:column;align-items:stretch;}
    .btn-box{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;margin-bottom:30px;}
    .form button.btn{width:fit-content;align-self:center}
    .hide{display:none!important}
    .muted{color:#666;font-size:.9rem}
    .link{color:#1e90ff;cursor:pointer;text-decoration:underline}
    .card{max-width:560px;margin:0 auto 12px;background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .picker-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:999}
    .picker-modal{background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);padding:20px;max-width:480px;width:92%;box-sizing:border-box;display:flex;flex-direction:column;gap:14px}
    .picker-title{font-size:1.1rem;font-weight:600;margin:0}
    .picker-options{display:flex;flex-direction:column;gap:10px}
    .picker-option{width:100%;justify-content:flex-start;display:flex;flex-direction:column;align-items:flex-start}
    .picker-option small{color:#555;font-weight:400}
    .picker-actions{display:flex;gap:10px;justify-content:flex-end;align-items:center}
    .picker-select{width:100%}
    .picker-hint{color:#444;margin:0}
  </style>

  <script>
    // –ü–æ–∑–Ω–∞—á–∞—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ª–æ–≥—ñ–Ω—É (—è–∫—â–æ —ñ–Ω—à—ñ —Å–∫—Ä–∏–ø—Ç–∏ —Ü–µ –≤—Ä–∞—Ö–æ–≤—É—é—Ç—å)
    window.IS_LOGIN_PAGE = true;

    const ROLE_PAGES = {
      def: "/admin/dashboard.html",      // –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä/–ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫
      teacher: "/teacher/dashboard.html", // –≤—á–∏—Ç–µ–ª—å
      parent: "/parent/dashboard.html",   // –º–∞–º–∞/–±–∞—Ç—å–∫–æ
      student: "/student/dashboard.html", // —É—á–µ–Ω—å
    };

    const ROLE_MAP = {
      contacts: "def",
      def: "def",
      admin: "def",
      teacher: "teacher",
      parent: "parent",
      parents: "parent",
      student: "student",
      child: "student",
    };

    function cacheProfile(u){
      if(!u) return;
      localStorage.setItem("user_id",      u.user_id);
      localStorage.setItem("user_name",    u.user_name);
      localStorage.setItem("user_access",  u.user_access || "");
      localStorage.setItem("extra_access", u.extra_access ?? "");
      localStorage.setItem("user_role",    u.user_access || "");
    }

    function normalizeRoles(primary, extra){
      const roles = new Set();
      const add = (raw) => {
        if(!raw) return;
        const clean = String(raw).trim().toLowerCase();
        const mapped = ROLE_MAP[clean] || clean;
        if(ROLE_PAGES[mapped]) roles.add(mapped);
      };

      const parseAndAdd = (value) => {
        if(!value) return;

        if(Array.isArray(value)){
          value.forEach(parseAndAdd);
          return;
        }

        if(typeof value === "object"){
          Object.entries(value).forEach(([key, val]) => {
            if(val) add(key);
          });
          return;
        }

        if(typeof value === "string"){
          const trimmed = value.trim();
          if(!trimmed) return;

          try {
            const parsed = JSON.parse(trimmed);
            return parseAndAdd(parsed);
          } catch {
            // ignore malformed JSON; fallback to simple parsing below
          }

          trimmed.split(/[,\s]+/).forEach(add);
          return;
        }

        add(value);
      };

      add(primary);
      parseAndAdd(extra);

      return Array.from(roles);
    }

    async function fetchProfile(){
      const r = await fetch("/api/login/me", { credentials: "include", cache: "no-store" });
      if(!r.ok) return null;
      const d = await r.json();
      const u = d.user || d;
      cacheProfile(u);
      return u;
    }

    async function redirectByRole(profile){
      const availableRoles = normalizeRoles(profile?.user_access, profile?.extra_access);
      const options = availableRoles.map(role => ({
        role,
        user_name: profile?.user_name,
        user_id: profile?.user_id,
      }));

      if(!options.length){
        return location.href = ROLE_PAGES.def;
      }

      if(options.length === 1){
        return location.href = ROLE_PAGES[options[0].role] || ROLE_PAGES.def;
      }

      const choice = await pickProfile(options, "–û–±–µ—Ä—ñ—Ç—å —Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥—É");
      if(choice?.role && ROLE_PAGES[choice.role]){
        location.href = ROLE_PAGES[choice.role];
      }
    }

    // üîê –¢–∏—Ö–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Å—ñ—ó –±–µ–∑ —à—É–º—É –≤ –∫–æ–Ω—Å–æ–ª—ñ —Ç–∞ –±–µ–∑ –∫–µ—à—É
    (async () => {
      try {
        const profile = await fetchProfile();
        if(profile){
          await redirectByRole(profile);
        }
        // 401 –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ª–æ–≥—ñ–Ω—É ‚Äî –æ—á—ñ–∫—É–≤–∞–Ω–æ, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ.
      } catch {
        // –æ—Ñ–ª–∞–π–Ω/—Ç–∏–º—á–∞—Å–æ–≤–æ ‚Äî —ñ–≥–Ω–æ—Ä—É—î–º–æ
      }
    })();
  </script>
</head>
<body>
  <header>
    <img src="img/helen-doron-english.svg" alt="Helen Doron English">
  </header>

  <main>
    <div class="btn-box">
      <button id="loginBtn" class="btn btn--blue btn--md">–í—Ö—ñ–¥</button>
      <button id="regBtn"   class="btn btn--green btn--md">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É -->
    <form id="loginForm" class="form card hide" autocomplete="on" novalidate>
      <input id="loginEmail" class="input" type="email" placeholder="Email" required autocomplete="username">
      <input id="loginPass"  class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required autocomplete="current-password">
      <button type="submit" class="btn btn--blue btn--md">–£–≤—ñ–π—Ç–∏</button>
      <div class="muted" style="margin-top:10px">
        –ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å? <span id="forgotLink" class="link">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–æ—Å—Ç—É–ø</span>
      </div>
    </form>

    <!-- –§–æ—Ä–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
    <form id="regForm" class="form card hide" novalidate>
      <input id="regName"    class="input" type="text"  placeholder="–Ü–º‚Äô—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ" required>
      <input id="regEmail"   class="input" type="email" placeholder="Email" required>
      <input id="regPhone"   class="input" type="tel"   placeholder="+380XXXXXXXXX" required>
      <input id="regPass"    class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" required>
      <button type="submit" class="btn btn--green btn--md">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
      <div class="muted" style="margin-top:10px">
        –ü—ñ—Å–ª—è —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω–æ–º –∑–º–æ–∂–µ—Ç–µ —É–≤—ñ–π—Ç–∏ —Å–≤–æ—ó–º email —Ç–∞ –ø–∞—Ä–æ–ª–µ–º.
      </div>
    </form>

    <!-- –§–æ—Ä–º–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è (–∑–∞ —Ç–æ–∫–µ–Ω–æ–º) -->
    <form id="resetForm" class="form card hide" novalidate>
      <div class="muted" style="margin-bottom:8px">–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</div>
      <input id="resetPass" class="input" type="password" placeholder="–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å (–º—ñ–Ω. 6)" required autocomplete="new-password">
      <button type="submit" class="btn btn--blue btn--md">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
    </form>
  </main>

  <script>
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("/sw.js");

    const loginForm = document.getElementById("loginForm"),
          regForm   = document.getElementById("regForm"),
          resetForm = document.getElementById("resetForm");

    document.getElementById("loginBtn").onclick = () => show(loginForm);
    document.getElementById("regBtn").onclick   = () => show(regForm);

    const ROLE_LABEL = {
      def: "–Ø –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫",
      teacher: "–Ø –≤—á–∏—Ç–µ–ª—å",
      parent: "–Ø –º–∞–º–∞/–±–∞—Ç—å–∫–æ",
      student: "–Ø —É—á–µ–Ω—å"
    };

    function pickProfile(profiles, title){
      return new Promise(resolve => {
        if(!profiles || !profiles.length) return resolve(null);

        const overlay = document.createElement("div");
        overlay.className = "picker-overlay";

        const modal = document.createElement("div");
        modal.className = "picker-modal card";

        const h = document.createElement("h3");
        h.className = "picker-title";
        h.textContent = title || "–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ—Ñ—ñ–ª—å";

        const hint = document.createElement("p");
        hint.className = "picker-hint";
        hint.textContent = "–ú–∏ –∑–Ω–∞–π—à–ª–∏ –¥–µ–∫—ñ–ª—å–∫–∞ –∞–∫–∞—É–Ω—Ç—ñ–≤ –∑–∞ —Ü–∏–º email. –•—Ç–æ –≤–∏ –∑–∞—Ä–∞–∑?";

        const optionsBox = document.createElement("div");
        optionsBox.className = "picker-options";

        const actions = document.createElement("div");
        actions.className = "picker-actions";

        const cancelBtn = document.createElement("button");
        cancelBtn.type = "button";
        cancelBtn.className = "btn btn--gray btn--sm";
        cancelBtn.textContent = "–°–∫–∞—Å—É–≤–∞—Ç–∏";

        const choose = (profile) => {
          overlay.remove();
          resolve(profile || null);
        };

        cancelBtn.onclick = () => choose(null);

        if(profiles.length <= 3){
          profiles.forEach(p => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn btn--blue btn--md picker-option";
            const label = ROLE_LABEL[p.role] || ROLE_LABEL[p.table] || (p.role || p.table || "–ü—Ä–æ—Ñ—ñ–ª—å");
            btn.innerHTML = `${label}<small>${p.user_name || "–ë–µ–∑ —ñ–º–µ–Ω—ñ"} ¬∑ ID: ${p.user_id}</small>`;
            btn.onclick = () => choose(p);
            optionsBox.appendChild(btn);
          });
          actions.appendChild(cancelBtn);
        } else {
          const select = document.createElement("select");
          select.className = "input picker-select";
          select.innerHTML = `<option value="">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ—Ñ—ñ–ª—å</option>` +
            profiles.map((p,i)=>{
              const label = ROLE_LABEL[p.role] || ROLE_LABEL[p.table] || (p.role || p.table || "–ü—Ä–æ—Ñ—ñ–ª—å");
              return `<option value="${i}">${label} ‚Äî ${p.user_name || "–ë–µ–∑ —ñ–º–µ–Ω—ñ"} (ID: ${p.user_id})</option>`;
            }).join("");
          optionsBox.appendChild(select);

          const okBtn = document.createElement("button");
          okBtn.type = "button";
          okBtn.className = "btn btn--blue btn--md";
          okBtn.textContent = "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏";
          okBtn.onclick = () => {
            const idx = parseInt(select.value, 10);
            if(Number.isNaN(idx)) return alert("–û–±–µ—Ä—ñ—Ç—å, —Ö—Ç–æ –≤–∏ –∑–∞—Ä–∞–∑");
            choose(profiles[idx]);
          };
          actions.append(cancelBtn, okBtn);
        }

        modal.append(h, hint, optionsBox, actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
      });
    }

    function show(el){
      [loginForm, regForm, resetForm].forEach(f => f.classList.add("hide"));
      el.classList.remove("hide");
    }

    /* --- –ª–æ–≥—ñ–Ω --- */
    loginForm.onsubmit = async e => {
      e.preventDefault();
      const email = loginEmail.value.trim().toLowerCase();
      const password = loginPass.value;
      if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) return alert("–ù–µ–≤—ñ—Ä–Ω–∏–π email");
      if(!password) return alert("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å");

      async function doLogin(body){
        const r = await fetch("/api/login/join",{
          method:"POST",
          credentials: "include",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(body)
        });
        const d = await r.json();
        if(d.choose_profile){
          const choice = await pickProfile(d.profiles, d.message || "–•—Ç–æ –≤–∏ –∑–∞—Ä–∞–∑?");
          if(!choice) return false;
          return doLogin({ ...body, target_user_id: choice.user_id, target_table: choice.table });
        }
        if(!r.ok) return alert(d.message || d.error || "–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É"), false;
        const profile = await fetchProfile();
        if(profile){
          await redirectByRole(profile);
        } else {
          location.href = ROLE_PAGES.def;
        }
        return true;
      }

      try{ await doLogin({ email, password }); }
      catch{ alert("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π"); }
    };

    /* --- —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è --- */
    regForm.onsubmit = async e => {
      e.preventDefault();
      const name  = regName.value.trim();
      const email = regEmail.value.trim().toLowerCase();
      let   phone = regPhone.value.replace(/\D/g,"");
      const pass  = regPass.value;

      if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) return alert("–ù–µ–≤—ñ—Ä–Ω–∏–π email");
      if(pass.length < 6) return alert("–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 6 —Å–∏–º–≤–æ–ª—ñ–≤");
      if(phone.startsWith("0")) phone="38"+phone;
      if(phone.length===9) phone="380"+phone;
      if(!phone.startsWith("380")) phone="380"+phone.slice(-9);
      phone="+"+phone;
      if(!/^\+380\d{9}$/.test(phone)) return alert("–¢–µ–ª–µ—Ñ–æ–Ω —É —Ñ–æ—Ä–º–∞—Ç—ñ +380XXXXXXXXX");

      try{
        const r = await fetch("/api/login/register",{
          method:"POST",
          credentials: "include",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            user_email : email,
            user_name  : name,
            user_phone : phone,
            pass_email : pass
          })
        });
        const d = await r.json();
        if(!r.ok){
          if(d.error === "already_registered"){
            if(confirm("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —ñ—Å–Ω—É—î. –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ø–∞—Ä–æ–ª—å?"))
              openForgot(email);
            return;
          }
          return alert(d.message || d.error || "‚ùå –ü–æ–º–∏–ª–∫–∞");
        }
        alert(d.message || "–ó–∞—è–≤–∫—É –ø—Ä–∏–π–Ω—è—Ç–æ. –û—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.");
        regForm.reset(); show(loginForm);
      }catch{ alert("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π"); }
    };

    /* --- –∑–∞–±—É–≤ –ø–∞—Ä–æ–ª—å (–∑–∞–≥–ª—É—à–∫–∞) --- */
    document.getElementById("forgotLink").onclick = () => openForgot();

    async function openForgot(prefillEmail){
      const email = prefillEmail || prompt("–í–∫–∞–∂—ñ—Ç—å email, –∑ —è–∫–∏–º –≤–∏ —Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—å:");
      if(!email) return;
      async function sendForgot(body){
        const r = await fetch("/api/login/forgot",{
          method:"POST",
          credentials: "include",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(body)
        });
        const d = await r.json();
        if(d.choose_profile){
          const choice = await pickProfile(d.profiles, d.message || "–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ—Ñ—ñ–ª—å –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è");
          if(!choice) return;
          return sendForgot({ ...body, target_user_id: choice.user_id, target_table: choice.table });
        }
        if(d.debug_link){ // –∫–æ–ª–∏ LOGIN_DEBUG=1
          if(confirm("–†–µ–∂–∏–º DEBUG: –≤—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è?")) location.href=d.debug_link;
        }
        alert(d.message || "–Ø–∫—â–æ –∞–∫–∞—É–Ω—Ç —ñ—Å–Ω—É—î ‚Äî –º–∏ –Ω–∞–¥—ñ—à–ª–µ–º–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –Ω–∞ email/Telegram.");
      }

      try{ await sendForgot({ email: email.trim().toLowerCase() }); }
      catch{ alert("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π"); }
    }

    /* --- —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è –∑–∞ —Ç–æ–∫–µ–Ω–æ–º --- */
    (function handleResetFromHash(){
      const m = (location.hash||"").match(/reset\?token=([^&]+)/);
      if(!m) return;
      const token = decodeURIComponent(m[1]);
      location.hash = "";        // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –∑ –∞–¥—Ä–µ—Å–∏
      show(resetForm);
      resetForm.onsubmit = async e => {
        e.preventDefault();
        const new_password = document.getElementById("resetPass").value;
        if(new_password.length < 6) return alert("–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 6 —Å–∏–º–≤–æ–ª—ñ–≤");
        try{
          const r = await fetch("/api/login/reset",{
            method:"POST",
            credentials: "include",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({ token, new_password })
          });
          const d = await r.json();
          if(!r.ok) return alert(d.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");
          alert("–ü–∞—Ä–æ–ª—å –∑–º—ñ–Ω–µ–Ω–æ. –í—Ö–æ–¥–∏–º–æ‚Ä¶");
          const profile = await fetchProfile();
          if (profile) {
            await redirectByRole(profile);
          } else {
            location.href = ROLE_PAGES.def;
          }
        }catch{ alert("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π"); }
      };
    })();
  </script>
</body>
</html>
